<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lugaz - Comparador de Luz</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <style>
        :root { --grad: linear-gradient(135deg, #0f172a 0%, #1e40af 50%, #0ea5e9 100%); }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Poppins', sans-serif; background: var(--grad); color: white; min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; text-align: center; padding: 40px 20px; }
        h1 { font-size: 5rem; font-weight: 700; background: linear-gradient(to right, #60a5fa, #a5f3fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .slogan { font-size: 1.7rem; color: #e2e8f0; margin-bottom: 50px; }
        .input-box { background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); border-radius: 24px; padding: 50px 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.4); max-width: 600px; margin: 0 auto; }
        input, button { width: 100%; padding: 18px; margin: 15px 0; border: none; border-radius: 14px; font-size: 1.1rem; }
        input { background: rgba(255,255,255,0.15); color: white; }
        button { background: #0ea5e9; color: white; cursor: pointer; font-size: 1.3rem; }
        button:hover { background: #0c8bd4; }
        #estado { margin-top: 15px; color: #fbbf24; font-weight: 600; }
        .resultado { display: none; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 50px; }
        .tarifa { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; border: 1px solid rgba(255,255,255,0.1); }
        .tarifa:hover { transform: translateY(-12px); box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        .empresa { font-size: 2rem; font-weight: 700; }
        .precio { font-size: 3.2rem; font-weight: 700; color: #34d399; }
        .ahorro { color: #fbbf24; font-size: 1.4rem; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Lugaz</h1>
        <p class="slogan">Compara tu factura de luz y ahorra hasta 400€ al año</p>
        <div class="input-box">
            <input type="email" id="email" placeholder="Tu email para enviarte las mejores ofertas">
            <input type="file" id="factura" accept=".pdf,.jpg,.jpeg,.png">
            <button id="botonComparar">¡Descubre cuánto puedes ahorrar!</button>
            <p id="estado"></p>
        </div>
        <div id="resultado" class="resultado"></div>
    </div>

    <script>
        const tarifas = [
            { empresa: "Endesa", nombre: "Permanencia 12 meses", kwh: 0.108, pot_punta: 0.122, pot_valle: 0.052, descuento: 28 },
            { empresa: "Iberdrola", nombre: "Sin permanencia", kwh: 0.112, pot_punta: 0.124, pot_valle: 0.054, descuento: 22 },
            { empresa: "Eleia", nombre: "Permanencia 12 meses", kwh: 0.115, pot_punta: 0.130, pot_valle: 0.045, descuento: 35 },
            { empresa: "Plenitude", nombre: "Sin permanencia", kwh: 0.104, pot_punta: 0.118, pot_valle: 0.050, descuento: 20 }
        ];

        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVi6XhMv1YpI2qZU97Rao8DhUdg0esgMJr3JdZEU05xhPnhiG_UWRq5LxbyD0QnHYw/exec";

        document.getElementById('botonComparar').addEventListener('click', procesarFactura);

        async function procesarFactura() {
            const email = document.getElementById("email").value.trim();
            const file = document.getElementById("factura").files[0];
            const estado = document.getElementById("estado");

            if (!email || !file) { estado.textContent = "Faltan datos"; return; }

            estado.textContent = "Leyendo tu factura...";

            let consumo = 350;
            let potencia = 5.75; // kW por defecto
            let alquiler = 0.81;
            let gastoActual = 85;

            try {
                const worker = Tesseract.createWorker({ logger: m => console.log(m) });
                await worker.load();
                await worker.loadLanguage('spa');
                await worker.initialize('spa');
                const { data: { text } } = await worker.recognize(file);
                await worker.terminate();

                const t = text.toLowerCase().replace(/o/g, '0').replace(/l/g, '1'); // corrección OCR común

                // Consumo
                const c = t.match(/consumo.*?(\d{3,5})/);
                if (c) consumo = parseInt(c[1]);

                // Potencia contratada
                const p = t.match(/potencia contratada.*?(\d+[.,]\d+)/);
                if (p) potencia = parseFloat(p[1].replace(',', '.'));

                // Alquiler
                const a = t.match(/alquiler.*?(\d+[.,]\d{2})/);
                if (a) alquiler = parseFloat(a[1].replace(',', '.'));

                // Importe total
                const g = t.match(/(importe total|a pagar|total factura).*?(\d{1,4}[,.]\d{2})/);
                if (g) gastoActual = parseFloat(g[2].replace(',', '.'));

                estado.textContent = `Leído: ${consumo} kWh · ${potencia} kW · ${gastoActual.toFixed(2)}€`;
            } catch (e) {
                estado.textContent = "Factura no leída → usando valores estimados";
            }

            fetch(GOOGLE_SCRIPT_URL + "?email=" + encodeURIComponent(email));

            setTimeout(() => mostrarResultados(consumo, potencia, alquiler, gastoActual), 1500);
        }

        function mostrarResultados(consumo, potencia, alquiler, gastoActual) {
            const resultado = document.getElementById("resultado");
            const dias = 30;
            let html = '<h2 style="grid-column:1/-1; color:#a5f3fc; margin-bottom:30px;">¡Tus mejores ofertas!</h2>';

            tarifas.forEach(t => {
                const energia = consumo * t.kwh;
                const potenciaCoste = (potencia * t.pot_punta * dias) + (potencia * t.pot_valle * dias);
                const base = energia + potenciaCoste;
                const impuesto = base * 0.05113;
                const baseIVA = base + impuesto + alquiler;
                const iva = baseIVA * 0.21;
                const totalSinDesc = baseIVA + iva;
                const totalConDesc = totalSinDesc * (1 - t.descuento / 100);
                const ahorroAnual = Math.round((gastoActual - totalConDesc) * 12);

                html += `
                    <div class="tarifa">
                        <div class="empresa">${t.empresa}</div>
                        <div style="color:#94a3b8;">${t.nombre}</div>
                        <div class="precio">${totalConDesc.toFixed(0)}€ <small>/mes</small></div>
                        <div class="ahorro">¡Ahorras ${ahorroAnual > 0 ? ahorroAnual : 0}€ al año!</div>
                        <div style="margin-top:10px; color:#94a3b8; font-size:0.9rem;">-${t.descuento}% primer año</div>
                    </div>
                `;
            });

            resultado.innerHTML = html;
            resultado.style.display = "grid";
        }
    </script>
</body>
</html>
