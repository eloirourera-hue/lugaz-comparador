<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lugaz - Comparador de Luz</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <style>
        /* Estilos CSS (tomados de tu style.css y adaptados) */
        body{margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#0f172a,#1e40af,#0ea5e9);color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background-attachment: fixed;}
        .card{background:rgba(255,255,255,0.1);backdrop-filter:blur(15px);border-radius:24px;padding:40px;max-width:500px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,0.4);border: 1px solid rgba(255,255,255,0.15);}
        h1{font-size:3.5rem;text-align:center;background:linear-gradient(to right,#60a5fa,#a5f3fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        input,button{width:100%;padding:16px;margin:12px 0;border:none;border-radius:12px;font-size:1.1rem}
        input{background:rgba(255,255,255,0.15);color:#fff}
        input::placeholder{color:#cbd5e1}
        button{background:#0ea5e9;color:#fff;cursor:pointer;font-size:1.3rem;box-shadow: 0 10px 30px rgba(14,165,233,0.5);}
        button:hover{background:#0c8bd4;transform: translateY(-2px);}
        #estado{margin-top:15px;color:#fbbf24;font-weight:600;text-align:center}
        .manual{display:none;background:rgba(255,255,255,0.1);padding:20px;border-radius:16px;margin-top:20px}
        .resultado{display:none;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-top:40px}
        .tarifa{background:rgba(255,255,255,0.1);padding:25px;border-radius:16px;text-align:center;transition:0.3s;border: 1px solid rgba(255,255,255,0.1);}
        .tarifa:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,0.4)}
        .empresa{font-size:1.9rem;font-weight:700}
        .precio{font-size:3rem;color:#34d399;margin:10px 0}
        .ahorro{font-size:1.3rem;color:#fbbf24}
        .resultado-title{grid-column:1/-1;text-align:center;color:#a5f3fc;margin:30px 0;font-size:2.5rem;}
        #datos-extraidos { margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 0.9rem; }
    </style>
</head>
<body>
<div class="card">
    <h1>Lugaz</h1>
    <p style="text-align:center;font-size:1.4rem;margin-bottom:30px">Sube tu factura o pon los datos manualmente</p>
    
    <input type="email" id="email" placeholder="Tu email" required>
    <input type="file" id="factura" accept=".pdf,.jpg,.jpeg,.png">
    <button onclick="procesar()">¡Calcular ahorro!</button>
    
    <div id="estado">Sube tu factura o usa modo manual ↓</div>
    <div id="datos-extraidos" style="display: none;"></div>

    <div class="manual" id="manual">
        <p>Modo manual (si la factura no se lee bien):</p>
        <input type="number" id="consumo" placeholder="Consumo kWh/mes (ej: 320)" required>
        <input type="number" step="0.01" id="potencia" placeholder="Potencia contratada kW (ej: 5.75)" value="5.75" required>
        <input type="number" step="0.01" id="gasto" placeholder="Gasto actual €/mes (ej: 78.45)" required>
        <button onclick="calcularManual()">Calcular Manual</button>
    </div>

    <div id="resultado" class="resultado"></div>
</div>

<script>
    // ⚠️ ATENCIÓN: REEMPLAZA ESTA URL CON LA QUE OBTUVISTE AL DESPLEGAR TU GOOGLE APPS SCRIPT.
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVi6XhMv1YpI2qZU97Rao8DhUdg0esgMJr3JdZEU05xhPnhiG_UWRq5LxbyD0QnHYw/exec";

    // -----------------------------------------------------------------------------
    // DATOS DE TARIFAS CORREGIDOS (TOMADOS DE TU tarifas.json Y SIMPLIFICADOS)
    // Usamos 'kwh_p', 'kwh_l', 'kwh_v', 'pot_p', 'pot_v' para la fórmula.
    // -----------------------------------------------------------------------------
    const tarifas = [
        { empresa: "Endesa", nombre: "One Luz 3 Periodos", kwh_p: 0.139, kwh_l: 0.109, kwh_v: 0.079, pot_p: 0.122, pot_v: 0.052, descuento: 25 },
        { empresa: "Iberdrola", nombre: "Plan Estable Online", kwh_p: 0.142, kwh_l: 0.112, kwh_v: 0.082, pot_p: 0.124, pot_v: 0.054, descuento: 20 },
        { empresa: "Naturgy", nombre: "Tarifa por Uso Nocturna", kwh_p: 0.155, kwh_l: 0.115, kwh_v: 0.069, pot_p: 0.130, pot_v: 0.045, descuento: 30 },
        { empresa: "Repsol", nombre: "Tarifa Online 2.0", kwh_p: 0.134, kwh_l: 0.104, kwh_v: 0.079, pot_p: 0.118, pot_v: 0.050, descuento: 15 }
    ];
    // -----------------------------------------------------------------------------

    // Variables globales (valores por defecto para el modo manual)
    let consumoGlobal = 350; // kWh/mes
    let potenciaGlobal = 5.75; // kW
    let gastoActualGlobal = 85.00; // €/mes
    const alquilerGlobal = 0.0267; // Precio alquiler contador (€/kW/día - Aprox. 0.81€/mes)

    // --- FUNCIONES DE EXTRACCIÓN MEJORADAS (Usando Tesseract) ---
    function extraerDatos(texto) {
        const t = texto.toLowerCase().replace(/[^0-9.,\s€kw]/g, ' ').replace(/,/g, '.');
        let consumo = consumoGlobal;
        let potencia = potenciaGlobal;
        let gasto = gastoActualGlobal;
        
        // 1. Consumo Mensual (Busca 3-6 dígitos seguidos de kWh/mes)
        const c = t.match(/consumo.*?\s*(\d{3,6})\s*kwh/i) || t.match(/(\d{3,6})\s*kwh/i);
        if (c) consumo = parseFloat(c[1]);

        // 2. Potencia contratada (Busca números con o sin decimales cerca de kW)
        const p = t.match(/potencia\s*contratada.*?\s*(\d+[\.]?\d*)\s*kw/i) || t.match(/(\d+[\.]?\d*)\s*kw/i);
        if (p) potencia = parseFloat(p[1]);

        // 3. Gasto total (Busca Total o Importe seguido de números con decimales y €)
        const g = t.match(/(?:total|importe).*?(\d{2,4}\.\d{2})\s*€/i);
        if (g) gasto = parseFloat(g[1]);
        
        return { consumo: consumo, potencia: potencia, gasto: gasto };
    }

    // --- FUNCIÓN PRINCIPAL DE PROCESAMIENTO ---
    async function procesar() {
        const email = document.getElementById("email").value.trim();
        const file = document.getElementById("factura").files[0];
        const estado = document.getElementById("estado");
        const manual = document.getElementById("manual");
        const datosExtraidos = document.getElementById("datos-extraidos");

        if (!email) { estado.textContent = "⚠️ Falta el email"; return; }
        if (!file) { manual.style.display = "block"; estado.textContent = "Sube la factura o rellena manualmente"; return; }

        estado.textContent = "Leyendo factura... (Esto puede tardar unos segundos)";
        datosExtraidos.style.display = "none";
        
        try {
            // Leer texto de la factura (PDF o imagen)
            const { data: { text } } = await Tesseract.recognize(file, 'spa', { logger: m => m });
            
            const datos = extraerDatos(text);
            consumoGlobal = datos.consumo;
            potenciaGlobal = datos.potencia;
            gastoActualGlobal = datos.gasto;

            estado.textContent = "✅ Lectura completada. Datos extraídos:";
            datosExtraidos.innerHTML = `Consumo: <strong>${consumoGlobal.toFixed(0)} kWh/mes</strong> · Potencia: <strong>${potenciaGlobal.toFixed(2)} kW</strong> · Gasto: <strong>${gastoActualGlobal.toFixed(2)} €/mes</strong>`;
            datosExtraidos.style.display = "block";
            manual.style.display = "block"; // Mostrar modo manual por si el usuario quiere ajustarlos

        } catch (e) {
            estado.textContent = "❌ No se pudo leer la factura → usa modo manual";
            manual.style.display = "block";
        }
        
        // Ejecutar el cálculo y el guardado de email
        calcularFinal();
    }

    // --- FUNCIÓN PARA MODO MANUAL ---
    function calcularManual() {
        const consumoInput = document.getElementById("consumo").value;
        const potenciaInput = document.getElementById("potencia").value;
        const gastoInput = document.getElementById("gasto").value;

        if (!consumoInput || !potenciaInput || !gastoInput) {
            document.getElementById("estado").textContent = "⚠️ Rellena todos los campos manuales.";
            return;
        }

        consumoGlobal = parseFloat(consumoInput);
        potenciaGlobal = parseFloat(potenciaInput);
        gastoActualGlobal = parseFloat(gastoInput);
        
        document.getElementById("estado").textContent = "Cálculo manual iniciado.";
        document.getElementById("datos-extraidos").style.display = "none";
        calcularFinal();
    }

    // --- FUNCIÓN DE CÁLCULO REALISTA (Para España) ---
    function calcularFinal() {
        const resultado = document.getElementById("resultado");
        const email = document.getElementById("email").value.trim();
        const dias = 30; // Cálculos en base a un mes (30 días)
        
        // Distribución de Consumo Típica (3 Periodos 2.0TD) - Esto es una aproximación estándar
        const factor_valle = 0.45;
        const factor_llano = 0.29;
        const factor_punta = 0.26;

        let html = '<h2 class="resultado-title">¡Estas son tus mejores ofertas!</h2>';
        let mejorAhorro = -Infinity;
        let datosGuardado = [];

        tarifas.forEach(t => {
            // 1. Coste de Energía (Consumo)
            const coste_energia_punta = (consumoGlobal * factor_punta) * t.kwh_p;
            const coste_energia_llano = (consumoGlobal * factor_llano) * t.kwh_l;
            const coste_energia_valle = (consumoGlobal * factor_valle) * t.kwh_v;
            const coste_energia_total = coste_energia_punta + coste_energia_llano + coste_energia_valle;

            // 2. Coste de Potencia (Fijo - P1 y P2)
            // t.pot_p y t.pot_v están en €/kW/día
            const coste_potencia_total = (potenciaGlobal * t.pot_p * dias) + (potenciaGlobal * t.pot_v * dias);

            // 3. Alquiler del Contador (Precio regulado - Aprox. 0.0267 €/día)
            const coste_alquiler = potenciaGlobal * alquilerGlobal * dias;

            // 4. Base Imponible (Energía + Potencia + Alquiler)
            const base = coste_energia_total + coste_potencia_total + coste_alquiler;

            // 5. Impuestos: Eléctrico (IE) e IVA
            // El Impuesto Eléctrico es 5.113% sobre Energía + Potencia (base)
            const impuesto_electrico = base * 0.05113; 
            const total_antes_iva = base + impuesto_electrico;
            const iva = total_antes_iva * 0.21; // 21% sobre todo lo anterior

            // 6. Coste Total Mensual Sin Descuento
            const totalSinDesc = total_antes_iva + iva;

            // 7. Coste Total Mensual Con Descuento (t.descuento es el porcentaje, ej: 25)
            const totalConDesc = totalSinDesc * (1 - t.descuento / 100);

            // 8. Ahorro Anual (Comparando Gasto Actual Mensual vs Nuevo Coste Mensual)
            const ahorroMensual = gastoActualGlobal - totalConDesc;
            const ahorroAnual = Math.round(ahorroMensual * 12);
            
            if (ahorroAnual > mejorAhorro) { mejorAhorro = ahorroAnual; }

            // Guardar datos para la Hoja de Cálculo
            datosGuardado.push({
                compania: t.empresa,
                ahorro_anual: ahorroAnual,
                coste_mensual: totalConDesc.toFixed(2)
            });


            html += `
                <div class="tarifa">
                    <div class="empresa">${t.empresa}</div>
                    <div style="color:#94a3b8;margin:8px 0">${t.nombre}</div>
                    <div class="precio">${totalConDesc.toFixed(2)}€<small style="font-size:1rem;">/mes</small></div>
                    <div class="ahorro">¡Ahorras ${ahorroAnual > 0 ? ahorroAnual : 0}€ al año!</div>
                    <div style="margin-top:10px;color:#94a3b8;font-size:0.9rem">-${t.descuento}% primer año</div>
                </div>
            `;
        });

        resultado.innerHTML = html;
        resultado.style.display = "grid";

        // 9. Guardar datos finales en Google Sheets
        if (email) {
            const datosFinales = {
                consumo_kwh_mes: consumoGlobal,
                potencia_kw: potenciaGlobal,
                gasto_original_mes: gastoActualGlobal,
                mejor_ahorro: mejorAhorro,
                ofertas: datosGuardado
            };
            
            // Enviamos el email y los datos completos serializados
            fetch(GOOGLE_SCRIPT_URL + "?email=" + encodeURIComponent(email) + "&datos=" + encodeURIComponent(JSON.stringify(datosFinales)));
        }
    }
</script>
</body>
</html>
